
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>AT91 Bootstrap Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="devicetree.html" />
    
    
    <link rel="prev" href="SAMBA.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../MX233/readme.html">
            
                <a href="../MX233/readme.html">
            
                    
                    MX233
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    SAM9N12
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="SAMBA.html">
            
                <a href="SAMBA.html">
            
                    
                    SAM-BA
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="AT91_Bootstrap.html">
            
                <a href="AT91_Bootstrap.html">
            
                    
                    AT91 Bootstrap
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="devicetree.html">
            
                <a href="devicetree.html">
            
                    
                    Device Tree
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="buildroot.html">
            
                <a href="buildroot.html">
            
                    
                    Buildroot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="linux.html">
            
                <a href="linux.html">
            
                    
                    Linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="OldSchool/readme.html">
            
                <a href="OldSchool/readme.html">
            
                    
                    Old School
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >AT91 Bootstrap</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="at91-bootstrap">AT91 Bootstrap</h1>
<p>In addition to SAM-BA, Atmel released AT91 Bootstrap, a secondary bootloader which handles clocking, DRAM initialization, and can even boot the Linux kernel directly without the need for U-Boot. They also made some good <a href="http://www.at91.com/linux4sam/bin/view/Linux4SAM/AT91Bootstrap" target="_blank">documentation</a> on it, though I found the code itself to be fairly messy and poorly documented. Heck, it&apos;s even written in C89 style where all the variables are at the top of functions and using <code>for(i = 0; i &lt; 100; i++)</code> instead of style <code>for(int i = 0; i &lt; 100; i++)</code> for loops.</p>
<p>Our first goal is to just get bootstrap both compiling and running on the board, after which comes the Linux kernel and busybox.</p>
<h2 id="configuring">Configuring</h2>
<p>To download the source code of AT91 Bootstrap and configure it, just do a git clone;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># Clone the git repo of AT91 Bootstrap</span>
git <span class="hljs-built_in">clone</span> https://github.com/linux4sam/at91bootstrap.git

<span class="hljs-comment"># Enter the directory of the git repo</span>
<span class="hljs-built_in">cd</span> at91bootstrap
</code></pre>
<p>This software by Atmel, and almost all other larger codebases that run on bare metal, use kconfig to configure itself (works with define&apos;s in C/C++ code and other various configuration). In here you can configure things like enabling the ability to direct boot the Linux kernel, where in dataflash the kernel and device tree is stored, where to copy them to in DRAM, and more.</p>
<p>To start off, we need to get the default configuration (defconfig) that represents our board. Since our board is based on the SAM9N12EK board from Atmel, we have to find the name of that defconfig. In the root of the repository we can do the following:</p>
<pre><code class="lang-bash">[hak8or@hak8or at91bootstrap_fiddle]$ find . -name <span class="hljs-string">&quot;*sam9n12*defconfig&quot;</span>
./board/at91sam9n12ek/at91sam9n12eksd_linux_image_dt_defconfig
./board/at91sam9n12ek/at91sam9n12eksd_linux_image_defconfig
./board/at91sam9n12ek/at91sam9n12eknf_uboot_defconfig
./board/at91sam9n12ek/at91sam9n12eksd_uboot_defconfig
./board/at91sam9n12ek/at91sam9n12ekdf_linux_image_dt_defconfig
./board/at91sam9n12ek/at91sam9n12eknf_linux_image_defconfig
./board/at91sam9n12ek/at91sam9n12ekdf_linux_image_defconfig
./board/at91sam9n12ek/at91sam9n12eknf_linux_image_dt_defconfig
./board/at91sam9n12ek/at91sam9n12ekdf_uboot_defconfig
</code></pre>
<p>The plan is to boot linux directly (so no uboot) and from dataflash instead of nandflash (so <code>df</code> instead of <code>nf</code>). We will also be using a device tree (more on that later), in which case we also want the <code>dt</code> acronym. What&apos;s left is <code>at91sam9n12ekdf_linux_image_dt_defconfig</code> so running <code>make at91sam9n12ekdf_linux_image_dt_defconfig</code> will create a config file in the root of the git repo that is just a copy of that <code>defconfig</code> file which <code>make menuconfig</code> will modify. Since we just want the bootstrap to compile and run for now, we only need to make two changes via <code>menuconfig</code>. First is in <code>slow clock configuration options</code> where you should uncheck <code>Use External 32KHZ oscillator</code> because this board does not have that component populated.</p>
<p>Secondly is the DRAM configuration. The DRAM used in the evaluation kit is the <code>MT47H64M16HR-3</code> while we use the <code>W9751G6KB-25</code>. Their IC has eight banks while ours has only 4, with the remaining timing paremeters being usable, so all we need to change is the following;</p>
<pre><code class="lang-c">[hak8or@hak8or at91bootstrap]$ git diff board/at91sam9n12ek/at91sam9n12ek.c
diff --git a/board/at91sam9n12ek/at91sam9n12ek.c b/board/at91sam9n12ek/at91sam9n12ek.c
index fee32d5..369dab8 100644
--- a/board/at91sam9n12ek/at91sam9n12ek.c
+++ b/board/at91sam9n12ek/at91sam9n12ek.c
@@ -74,7 +74,7 @@ static void ddramc_reg_config(struct ddramc_register *ddramc_config)
        ddramc_config-&gt;cr = (AT91C_DDRC2_NC_DDR10_SDR9  // 10 column bits (1K)
                                | AT91C_DDRC2_NR_13     // 13 row bits    (8K)
                                | AT91C_DDRC2_CAS_3     // CAS Latency 3
-                               | AT91C_DDRC2_NB_BANKS_8        // 8 banks
+                               | AT91C_DDRC2_NB_BANKS_4        // 4 banks
                                | AT91C_DDRC2_DISABLE_RESET_DLL
                                | AT91C_DDRC2_DECOD_INTERLEAVED);
</code></pre>
<h2 id="toolchain">Toolchain</h2>
<p>This is where many run into issues, how to handle the toolchain. The way this guide is set up uses a fairly painless process on how to handle the toolchains for this project. This is also all done in an Arch Linux based distro for simplicities sake (Ubuntu PPA&apos;s tend to be so old that you have to manually add a PPA, Arch uses AUR which has a huge amount of packages which are actually up to date since it&apos;s a rolling release). There are two types of compilers we will use, <code>arm-none-***</code>
and <code>arm-linux-***</code>, the first of which being used for AT91 Bootstrap and SAM-BA applets while the second is for the Linux Kernel and cross compiling binaries running on the board under linux.</p>
<p>In Arch, simply doing <code>pacman -S arm-none-eabi-gcc</code> will get you the newest (<code>7.3.0</code> as of writing) toolchain, but under Ubuntu it seems doing <code>apt get install arm-none-eabi-gcc</code> should also suffice. For <code>arm-linux***</code> buildroot will be used (it fetches the toolchain and compiles everything for you, crazy stuff).</p>
<h2 id="compiling">Compiling</h2>
<p>Now that we have a compiler, we should be able to just run <code>make CROSS_COMPILE=arm-none-eabi-</code> successfully.</p>
<pre><code class="lang-bash">[hak8or@hak8or at91bootstrap_fiddle]$ make CROSS_COMPILE=arm-none-eabi-
CC
========
arm-none-eabi-gcc 7.3.0

as FLAGS
========
-g -Os -Wall -I/home/hak8or/Desktop/armboard/at91bootstrap_fiddle/board/at91sam9n12ek -Iinclude -Icontrib/include -DJUMP_ADDR=0x22000000 -DTOP_OF_MEMORY=0x308000 -DMACH_TYPE=9999 -Dat91sam9n12ek -DMACH_TYPE=9999 -DTOP_OF_MEMORY=0x308000 -DCRYSTAL_16_000MHZ -DAT91SAM9N12 -mcpu=arm926ej<span class="hljs-_">-s</span> -mtune=arm926ej<span class="hljs-_">-s</span> -mfloat-abi=soft -DCONFIG_THUMB -mthumb-interwork -DCONFIG_AT91SAM9N12EK

gcc FLAGS
=========
-nostdinc -isystem /usr/lib/gcc/arm-none-eabi/7.3.0/include -ffunction-sections -g -Os -Wall -mno-unaligned-access -fno-stack-protector -fno-common -fno-builtin -I/home/hak8or/Desktop/armboard/at91bootstrap_fiddle/board/at91sam9n12ek -Icontrib/include -Iinclude -Ifs/include -I/home/hak8or/Desktop/armboard/at91bootstrap_fiddle/config/at91bootstrap-config -DAT91BOOTSTRAP_VERSION=<span class="hljs-string">&quot;3.8.10-rc1-dirty&quot;</span> -DCOMPILE_TIME=<span class="hljs-string">&quot;Tue Mar 27 02:26:14 EDT 2018&quot;</span> -DIMG_ADDRESS=0x00040000 -DIMG_SIZE= -DJUMP_ADDR=0x22000000 -DOF_OFFSET=0x00008400 -DOF_ADDRESS=0x21000000 -DMEM_BANK=0x20000000 -DMEM_SIZE=0x8000000 -DIMAGE_NAME=<span class="hljs-string">&quot;&quot;</span> -DCMDLINE=<span class="hljs-string">&quot;&quot;</span> -DCMDLINE_FILE=<span class="hljs-string">&quot;&quot;</span> -DTOP_OF_MEMORY=0x308000 -DMACH_TYPE=9999 -DCONFIG_DEBUG -DBANNER=<span class="hljs-string">&quot;\n\nAT91Bootstrap &quot;</span> AT91BOOTSTRAP_VERSION <span class="hljs-string">&quot; (&quot;</span> COMPILE_TIME <span class="hljs-string">&quot;)\n\n&quot;</span> -DCONFIG_HW_DISPLAY_BANNER -DCONFIG_HW_INIT -Dat91sam9n12ek -DMACH_TYPE=9999 -DTOP_OF_MEMORY=0x308000 -DCRYSTAL_16_000MHZ -DAT91SAM9N12 -mcpu=arm926ej<span class="hljs-_">-s</span> -mtune=arm926ej<span class="hljs-_">-s</span> -mfloat-abi=soft -DCONFIG_THUMB -mthumb -mthumb-interwork -DCONFIG_SCLK -DCONFIG_CRYSTAL_16_000MHZ -DCONFIG_CPU_CLK_400MHZ -DCONFIG_BUS_SPEED_133MHZ -DCPU_HAS_PIO3 -DCONFIG_AT91SAM9N12EK -DCONFIG_DDRC -DCONFIG_DDR2 -DCONFIG_RAM_64MB -DCONFIG_DATAFLASH -DCONFIG_LOAD_LINUX -DCONFIG_LINUX_IMAGE -DCONFIG_OF_LIBFDT -DCONFIG_DATAFLASH_RECOVERY -DCONFIG_SMALL_DATAFLASH -DAT91C_SPI_CLK=33000000 -DAT91C_SPI_PCS_DATAFLASH=AT91C_SPI_PCS0_DATAFLASH -DBOOTSTRAP_DEBUG_LEVEL=DEBUG_INFO -DCONFIG_DISABLE_WATCHDOG -DCPU_HAS_HSMCI0 -DCONFIG_SPI_BUS0 -DCONFIG_SPI

ld FLAGS
========
-nostartfiles -Map=/home/hak8or/Desktop/armboard/at91bootstrap_fiddle/binaries/at91sam9n12ek-dataflashboot-linux--dt-3.8.10-rc1.map --cref -static -T elf32-littlearm.lds --gc-sections -Ttext 0x300000

  AS        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/crt0_gnu.S
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/main.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/board/at91sam9n12ek/at91sam9n12ek.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/lib/string.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/lib/eabi_utils.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/lib/div.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/lib/fdt.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/debug.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_slowclk.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/common.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_pio.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/pmc.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_pit.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_wdt.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_usart.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_rstc.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/ddramc.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/at91_spi.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/spi_flash.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/dataflash.c
  CC        /home/hak8or/Desktop/armboard/at91bootstrap_fiddle/driver/load_kernel.c
  LD        at91sam9n12ek-dataflashboot-linux--dt-3.8.10-rc1.elf
Size of at91sam9n12ek-dataflashboot-linux--dt-3.8.10-rc1.bin is 8336 bytes
[Succeeded] It<span class="hljs-string">&apos;s OK to fit into SRAM area
[Attention] The space left for stack is 14664 bytes
</span></code></pre>
<h2 id="booting">Booting</h2>
<p>We need to copy the resulting <code>boot.bin</code> (which is a symlink to <code>t91sam9n12ek-dataflashboot-linux--dt-3.8.10-rc1.bin</code>) to dataflash. Do <strong>not</strong> use just &quot;copy file&quot; because the ROM bootloader needs some extra information. Using the &quot;Save Boot File&quot; applet in SAM-BA will generate and save this extra information.</p>
<p><img src="images/AT91Bootstrap_Flash.PNG" alt="AT91 Bootstrap Output"></p>
<p>And when we restart the board then on the serial port we should be seeing the following;</p>
<pre><code class="lang-none">RomBOOT



AT91Bootstrap 3.8.10-rc1-dirty (Tue Mar 27 02:26:14 EDT 2018)

SF: Got Manufacturer and Device ID: 0x1f 0x27 0x1 0x1 0x0
SF: Press the recovery button (PB4) to recovery
SF: Failed to load image
</code></pre>
<p>Looks like we have AT91 Bootstrap compiling, running, and interpreting the Dataflash IC correctly! Next up, is getting a new toolchain with buildroot and compiling the Linux kernel.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="SAMBA.html" class="navigation navigation-prev " aria-label="Previous page: SAM-BA">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="devicetree.html" class="navigation navigation-next " aria-label="Next page: Device Tree">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"AT91 Bootstrap","level":"1.3.2","depth":2,"next":{"title":"Device Tree","level":"1.3.3","depth":2,"path":"AT91SAM9N12/devicetree.md","ref":"AT91SAM9N12/devicetree.md","articles":[]},"previous":{"title":"SAM-BA","level":"1.3.1","depth":2,"path":"AT91SAM9N12/SAMBA.md","ref":"AT91SAM9N12/SAMBA.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"AT91SAM9N12/AT91_Bootstrap.md","mtime":"2018-03-29T06:52:41.877Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-03-29T22:40:19.576Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

